<!--mine.wxml-->
<view class="mine-container">
  <!-- 用户信息区域 -->
  <view class="user-header">
    <!-- 未登录状态 -->
    <block wx:if="{{!isLoggedIn}}">
      <view class="avatar-wrapper">
        <image class="avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
      </view>
      <view class="login-section">
        <view class="login-btn" bindtap="showLoginPopup">登录/注册</view>
        <text class="login-tip">登录后享受更多服务</text>
      </view>
    </block>

    <!-- 已登录状态 -->
    <block wx:else>
      <view class="avatar-wrapper">
        <image class="avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
        <button class="avatar-overlay" open-type="chooseAvatar" hover-class="none" bind:chooseavatar="onChooseAvatar"></button>
      </view>
      <view class="user-info-right">
        <view class="nickname-row">
          <input type="nickname" class="nickname-input" value="{{userInfo.nickName}}" bind:change="onInputChange" placeholder="点击设置昵称" />
        </view>
        <text class="phone-display">{{userInfo.phoneNumber}}</text>
      </view>
    </block>
  </view>

  <!-- 常用功能区域 -->
  <view class="common-functions">
    <view class="section-title">常用功能</view>
    <view class="function-grid">
      <view class="function-item" bindtap="goToFavorites">
        <image class="function-icon" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM2NjY2NjYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjAuODQgNC42MWE1LjUgNS41IDAgMCAwLTcuNzggMEwxMiA1LjY3bC0xLjA2LTEuMDZhNS41IDUuNSAwIDAgMC03Ljc4IDcuNzhsMS4wNiAxLjA2TDEyIDIxLjIzbDcuNzgtNy43OCAxLjA2LTEuMDZhNS41IDUuNSAwIDAgMCAwLTcuNzh6Ij48L3BhdGg+PC9zdmc+" mode="aspectFit"></image>
        <text class="function-text">我的收藏</text>
      </view>
      <view class="function-item" bindtap="goToOrders">
        <image class="function-icon" src="/images/orders-icon.png" mode="aspectFit"></image>
        <text class="function-text">我的订单</text>
      </view>
      <view class="function-item" bindtap="goToAddress">
        <image class="function-icon" src="/images/address-icon.png" mode="aspectFit"></image>
        <text class="function-text">我的地址</text>
      </view>
      <view class="function-item" bindtap="contactShop">
        <image class="function-icon" src="/images/contact-icon.png" mode="aspectFit"></image>
        <text class="function-text">联系客服</text>
      </view>
    </view>
  </view>

  <!-- 退出登录按钮 (仅登录后显示) -->
  <view wx:if="{{isLoggedIn}}" class="logout-section">
    <view class="logout-btn" bindtap="handleLogout">退出登录</view>
  </view>
</view>

<!-- 登录弹窗 -->
<view class="login-popup-mask {{showLoginPopup ? 'show' : ''}}" bindtap="hideLoginPopup"></view>
<view class="login-popup {{showLoginPopup ? 'show' : ''}}">
  <view class="popup-header">
    <text class="popup-title">登录/注册</text>
    <view class="popup-close" bindtap="hideLoginPopup">×</view>
  </view>
  <view class="popup-content">
    <view class="popup-desc">授权手机号快速登录，享受完整服务</view>
    <!-- 隐私协议勾选 -->
    <view class="privacy-agreement">
      <view class="checkbox-wrapper" bindtap="togglePrivacyAgreement">
        <view class="checkbox {{agreedPrivacy ? 'checked' : ''}}">
          <text wx:if="{{agreedPrivacy}}" class="check-icon">✓</text>
        </view>
      </view>
      <view class="agreement-text">
        <text>已阅读并同意</text>
        <text class="link" catchtap="viewPrivacyPolicy">《用户隐私协议》</text>
      </view>
    </view>
    <!-- 确认按钮（勾选后触发手机号授权） -->
    <button 
      wx:if="{{agreedPrivacy}}" 
      class="confirm-login-btn" 
      open-type="getPhoneNumber" 
      bindgetphonenumber="onGetPhoneNumber">
      同意并登录
    </button>
    <button 
      wx:else 
      class="confirm-login-btn disabled" 
      bindtap="onLoginBtnTap">
      同意并登录
    </button>
  </view>
</view>
