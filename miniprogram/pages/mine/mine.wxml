<!--mine.wxml-->
<navigation-bar title="我的" back="{{false}}" color="white" background="linear-gradient(135deg, rgba(130, 180, 170, 0.75) 0%, rgba(100, 160, 150, 0.85) 50%, rgba(90, 150, 145, 0.9) 100%)"></navigation-bar>

<view class="mine-container">
  <!-- 用户信息区域 -->
  <view class="user-header">
    <!-- 未登录状态 -->
    <block wx:if="{{!isLoggedIn}}">
      <view class="avatar-wrapper">
        <image class="avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
      </view>
      <view class="login-section">
        <view class="login-btn" bindtap="showLoginPopup">登录/注册</view>
        <text class="login-tip">登录后享受更多服务</text>
      </view>
    </block>

    <!-- 已登录状态 -->
    <block wx:else>
      <view class="avatar-wrapper {{avatarHighlight ? 'highlight' : ''}}">
        <image class="avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
        <button class="avatar-overlay" open-type="chooseAvatar" hover-class="none" bind:chooseavatar="onChooseAvatar"></button>
        <view class="avatar-pulse"></view>
      </view>
      <view class="user-info-right">
        <view class="nickname-row {{nicknameHighlight ? 'highlight' : ''}}">
          <input type="nickname" class="nickname-input" value="{{userInfo.nickName}}" bind:change="onInputChange" placeholder="点击设置昵称" />
          <view class="nickname-pulse"></view>
        </view>
        <text class="phone-display">{{userInfo.phoneNumber}}</text>
      </view>
    </block>
  </view>

  <!-- 订单状态快捷入口 -->
  <view class="order-status-section">
    <view class="order-status-grid">
      <view class="order-status-item" bindtap="goToOrdersByStatus" data-status="pending">
        <view class="status-icon-wrapper">
          <text class="status-icon">📋</text>
          <view wx:if="{{orderCounts.pending > 0}}" class="status-badge">{{orderCounts.pending}}</view>
        </view>
        <text class="status-text">待确认</text>
      </view>
      <view class="order-status-item" bindtap="goToOrdersByStatus" data-status="preparing">
        <view class="status-icon-wrapper">
          <text class="status-icon">📦</text>
          <view wx:if="{{orderCounts.preparing > 0}}" class="status-badge">{{orderCounts.preparing}}</view>
        </view>
        <text class="status-text">备货中</text>
      </view>
      <view class="order-status-item" bindtap="goToOrdersByStatus" data-status="shipping">
        <view class="status-icon-wrapper">
          <text class="status-icon">🚚</text>
          <view wx:if="{{orderCounts.shipping > 0}}" class="status-badge">{{orderCounts.shipping}}</view>
        </view>
        <text class="status-text">配送中</text>
      </view>
      <view class="order-status-item" bindtap="goToOrdersByStatus" data-status="all">
        <view class="status-icon-wrapper">
          <text class="status-icon">✅</text>
        </view>
        <text class="status-text">全部订单</text>
      </view>
    </view>
  </view>

  <!-- 常用功能区域 -->
  <view class="common-functions">
    <view class="section-title">常用功能</view>
    <view class="function-grid">
      <view class="function-item" bindtap="goToFavorites">
        <text class="function-icon-emoji">❤️</text>
        <text class="function-text">我的收藏</text>
      </view>
      <view class="function-item" bindtap="goToFootprints">
        <text class="function-icon-emoji">👣</text>
        <text class="function-text">我的足迹</text>
      </view>
      <view class="function-item" bindtap="goToAddress">
        <text class="function-icon-emoji">📍</text>
        <text class="function-text">收货地址</text>
      </view>
      <view class="function-item" bindtap="goToInvoice">
        <text class="function-icon-emoji">🧾</text>
        <text class="function-text">发票管理</text>
      </view>
    </view>
  </view>

  <!-- 服务与帮助 -->
  <view class="service-help-section">
    <view class="section-title">服务与帮助</view>
    <view class="service-list">
      <view class="service-item" bindtap="goToFAQ">
        <view class="service-left">
          <text class="service-icon">❓</text>
          <text class="service-name">常见问题</text>
        </view>
        <text class="service-arrow">›</text>
      </view>
      <view class="service-item" bindtap="goToAbout">
        <view class="service-left">
          <text class="service-icon">📋</text>
          <text class="service-name">关于我们</text>
        </view>
        <text class="service-arrow">›</text>
      </view>
    </view>
  </view>

  <!-- 温馨提示 -->
  <view class="tips-card">
    <view class="tips-title">💡 温馨提示</view>
    <text class="tips-content">本平台为预约下单平台，商家确认后将根据您的地址安排配送或物流发货</text>
  </view>

  <!-- 退出登录按钮 (仅登录后显示) -->
  <view wx:if="{{isLoggedIn}}" class="logout-section">
    <view class="logout-btn" bindtap="handleLogout">退出登录</view>
  </view>
</view>

<!-- 登录弹窗 -->
<view class="login-popup-mask {{showLoginPopup ? 'show' : ''}}" bindtap="hideLoginPopup"></view>
<view class="login-popup {{showLoginPopup ? 'show' : ''}}">
  <view class="popup-header">
    <text class="popup-title">登录/注册</text>
    <view class="popup-close" bindtap="hideLoginPopup">×</view>
  </view>
  <view class="popup-content">
    <view class="popup-desc">授权手机号快速登录，享受完整服务</view>
    <!-- 隐私协议勾选 -->
    <view class="privacy-agreement">
      <view class="checkbox-wrapper" bindtap="togglePrivacyAgreement">
        <view class="checkbox {{agreedPrivacy ? 'checked' : ''}}">
          <text wx:if="{{agreedPrivacy}}" class="check-icon">✓</text>
        </view>
      </view>
      <view class="agreement-text">
        <text>已阅读并同意</text>
        <text class="link" catchtap="viewPrivacyPolicy">《用户隐私协议》</text>
      </view>
    </view>
    <!-- 确认按钮（勾选后触发手机号授权） -->
    <button 
      wx:if="{{agreedPrivacy}}" 
      class="confirm-login-btn" 
      open-type="getPhoneNumber" 
      bindgetphonenumber="onGetPhoneNumber">
      同意并登录
    </button>
    <button 
      wx:else 
      class="confirm-login-btn disabled" 
      bindtap="onLoginBtnTap">
      同意并登录
    </button>
  </view>
</view>

<!-- 隐私协议弹窗 -->
<view class="privacy-popup-mask {{showPrivacyPopup ? 'show' : ''}}" bindtap="hidePrivacyPopup"></view>
<view class="privacy-popup {{showPrivacyPopup ? 'show' : ''}}">
  <view class="privacy-popup-header">
    <text class="privacy-popup-title">用户隐私协议</text>
    <view class="privacy-popup-close" bindtap="hidePrivacyPopup">×</view>
  </view>
  <scroll-view class="privacy-popup-content" scroll-y enhanced show-scrollbar="{{false}}">
    <view class="privacy-text">
      <view class="privacy-intro">本小程序（贵发祥丨殡葬寿衣冰棺骨灰盒）非常重视用户个人信息和隐私的保护。在您使用本小程序服务前，请仔细阅读并充分理解本隐私协议内容。当您点击"同意"或继续使用本小程序服务，即视为您已充分理解并同意本协议。</view>
      
      <view class="privacy-section-title">一、我们收集的信息及用途</view>
      <view class="privacy-section-desc">我们将在取得您的明示同意后，根据业务功能需要，收集和使用以下信息：</view>
      
      <view class="privacy-item"><text class="privacy-item-title">1. 微信昵称、头像</text><text class="privacy-item-desc">用于显示用户身份信息、实现账户标识。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">2. 位置信息</text><text class="privacy-item-desc">用于显示距离、根据地理位置推荐服务或内容。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">3. 地址信息</text><text class="privacy-item-desc">用于定位、配送、服务联系等相关功能。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">4. 发票信息</text><text class="privacy-item-desc">用于开具发票及维护消费记录。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">5. 麦克风权限</text><text class="privacy-item-desc">在您需要通过语音互动或语音输入时使用。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">6. 您选中的照片或视频信息</text><text class="privacy-item-desc">用于提前上传、优化上传速度。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">7. 摄像头权限</text><text class="privacy-item-desc">用于拍摄照片或视频并完成上传。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">8. 手机号码</text><text class="privacy-item-desc">用于登录、注册及身份验证。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">9. 通讯录权限（仅写入）</text><text class="privacy-item-desc">用于将联系信息写入您的通讯录（不读取通讯录内容）。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">10. 设备信息</text><text class="privacy-item-desc">用于保障网络服务、安全运行、功能优化。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">11. 身份证号码</text><text class="privacy-item-desc">用于实名认证及相关需实名的服务。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">12. 订单信息</text><text class="privacy-item-desc">用于展示订单、售后服务、物流查询等功能。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">13. 您发布的内容</text><text class="privacy-item-desc">用于互动、评论、内容展示等功能。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">14. 您关注的账号信息</text><text class="privacy-item-desc">用于提供订阅提醒与互动通知。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">15. 操作日志</text><text class="privacy-item-desc">用于运营维护、服务优化与安全分析。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">16. 相册权限（仅写入）</text><text class="privacy-item-desc">用于保存您编辑或生成的图片，以及用于上传内容。</text></view>
      <view class="privacy-item"><text class="privacy-item-title">17. 您选中的文件</text><text class="privacy-item-desc">用于提前上传以提升文件上传效率。</text></view>
      
      <view class="privacy-section-title">二、拒绝授权的影响</view>
      <view class="privacy-section-desc">您可以拒绝授权上述可选权限，但可能会导致相关功能无法正常使用，不影响您访问不需要该权限的其他功能。</view>
      
      <view class="privacy-section-title">三、信息的存储与保护</view>
      <view class="privacy-section-desc">我们将采用合理的安全手段保护您的个人信息，防止未经授权的访问、披露、修改或丢失。</view>
      
      <view class="privacy-section-title">四、信息的共享、转让与公开披露</view>
      <view class="privacy-section-desc">除法律法规要求或获得您的另行同意外，我们不会共享、转让或公开披露您的个人信息。</view>
      
      <view class="privacy-section-title">五、您的权利</view>
      <view class="privacy-section-desc">您有权查询、更正、删除您的个人信息，也可以撤回相关授权。您可通过小程序内的相关功能入口或联系客服进行操作。</view>
      
      <view class="privacy-section-title">六、隐私协议的更新</view>
      <view class="privacy-section-desc">根据业务变化，我们可能更新本协议。重大变更将通过小程序公告或弹窗方式提示，并再次征求您的同意。</view>
      
      <view class="privacy-footer">如您对本隐私协议有任何疑问，可随时联系我们。</view>
    </view>
  </scroll-view>
  <view class="privacy-popup-footer">
    <view class="privacy-confirm-btn" bindtap="confirmPrivacyPolicy">我已阅读</view>
  </view>
</view>
